<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Jakarta EE Documentation</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Jakarta EE Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jakarta-ee-docs" data-version="9">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Jakarta EE Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../security-intro/security-intro.html">Introduction to Security in the Jakarta EE Platform</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../security-webtier/security-webtier.html">Getting Started Securing Web Applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../security-jakartaee/security-jakartaee.html">Getting Started Securing Enterprise Applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../security-api/security-api.html">Using Jakarta Security</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="security-advanced001.html">security-advanced/security-advanced001.adoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Jakarta EE Documentation</span>
    <span class="version">9</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../../current/index.html">Jakarta EE Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../current/index.html">10</a>
        </li>
        <li class="version is-current">
          <a href="../../index.html">9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../current/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">9</button>
  <div class="version-menu">
    <a class="version" href="../../../current/security/security-advanced/security-advanced002.html">10</a>
    <a class="version is-current" href="security-advanced002.html">9</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/virtua-tech/jakartaee-tutorial/edit/antora-prototype-9/src/main/docs/modules/security/pages/security-advanced/security-advanced002.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_authentication_mechanisms"><a class="anchor" href="#_authentication_mechanisms"></a>Authentication Mechanisms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section discusses the client authentication and mutual authentication mechanisms.</p>
</div>
<div class="sect2">
<h3 id="_client_authentication"><a class="anchor" href="#_client_authentication"></a>Client Authentication</h3>
<div class="paragraph">
<p>With client authentication, the web server authenticates the client by using the client&#8217;s public key certificate.
Client authentication is a more secure method of authentication than either basic or form-based authentication.
It uses HTTP over SSL (HTTPS), in which the server authenticates the client using the client&#8217;s public key certificate.
SSL technology provides data encryption, server authentication, message integrity, and optional client authentication for a TCP/IP connection.
You can think of a public key certificate as the digital equivalent of a passport.
The certificate is issued by a trusted organization, a certificate authority (CA), and provides identification for the bearer.</p>
</div>
<div class="paragraph">
<p>Before using client authentication, make sure that the client has a valid public key certificate.
For more information on creating and using public key certificates, read <a href="#_working_with_digital_certificates">[_working_with_digital_certificates]</a>.</p>
</div>
<div class="paragraph">
<p>The following example shows how to declare client authentication in your deployment descriptor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;login-config&gt;
    &lt;auth-method&gt;CLIENT-CERT&lt;/auth-method&gt;
&lt;/login-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jakarta Security provides an alternative means to configure client authentication using the <code>HttpAuthenticationMechanism</code> interface.
This interface defines an SPI for writing authentication mechanisms that can be provided with an application and deployed using CDI.
See <a href="#_overview_of_the_http_authentication_mechanism_interface">[_overview_of_the_http_authentication_mechanism_interface]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mutual_authentication"><a class="anchor" href="#_mutual_authentication"></a>Mutual Authentication</h3>
<div class="paragraph">
<p>With mutual authentication, the server and the client authenticate each other.
Mutual authentication is of two types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Certificate-based (see <a href="#_certificate_based_mutual_authentication">Certificate-Based Mutual Authentication</a>)</p>
</li>
<li>
<p>User name/password-based (see <a href="#_username_password_based_mutual_authentication">User Name/Password-Based Mutual Authentication</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using certificate-based mutual authentication, the following actions occur.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A client requests access to a protected resource.</p>
</li>
<li>
<p>The web server presents its certificate to the client.</p>
</li>
<li>
<p>The client verifies the server&#8217;s certificate.</p>
</li>
<li>
<p>If successful, the client sends its certificate to the server.</p>
</li>
<li>
<p>The server verifies the client&#8217;s credentials.</p>
</li>
<li>
<p>If successful, the server grants access to the protected resource requested by the client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#_certificate_based_mutual_authentication">Certificate-Based Mutual Authentication</a> shows what occurs during certificate-based mutual authentication.</p>
</div>
<div id="_certificate_based_mutual_authentication" class="imageblock">
<div class="content">
<img src="../../images/_images/jakartaeett_dt_048.svg" alt="Diagram of six steps in mutual authentication with certificates">
</div>
<div class="title">Figure 1. Certificate-Based Mutual Authentication</div>
</div>
<div class="paragraph">
<p>In user name/password-based mutual authentication, the following actions occur.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A client requests access to a protected resource.</p>
</li>
<li>
<p>The web server presents its certificate to the client.</p>
</li>
<li>
<p>The client verifies the server&#8217;s certificate.</p>
</li>
<li>
<p>If successful, the client sends its user name and password to the server.</p>
</li>
<li>
<p>The server verifies the client&#8217;s credentials</p>
</li>
<li>
<p>If the verification is successful, the server grants access to the protected resource requested by the client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#_username_password_based_mutual_authentication">User Name/Password-Based Mutual Authentication</a> shows what occurs during user name/password-based mutual authentication.</p>
</div>
<div id="_username_password_based_mutual_authentication" class="imageblock">
<div class="content">
<img src="../../images/_images/jakartaeett_dt_049.svg" alt="Diagram of five steps in mutual authentication with user name and password">
</div>
<div class="title">Figure 2. User Name/Password-Based Mutual Authentication</div>
</div>
<div class="sect3">
<h4 id="_enabling_mutual_authentication_over_ssl"><a class="anchor" href="#_enabling_mutual_authentication_over_ssl"></a>Enabling Mutual Authentication over SSL</h4>
<div class="paragraph">
<p>This section discusses setting up client-side authentication.
Enabling both server-side and client-side authentication is called mutual, or two-way, authentication.
In client authentication, clients are required to submit certificates issued by a certificate authority that you choose to accept.</p>
</div>
<div class="paragraph">
<p>There are at least two ways to enable mutual authentication over SSL.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The preferred method is to set the method of authentication in the <code>web.xml</code> application deployment descriptor to <code>CLIENT-CERT</code>.
This enforces mutual authentication by modifying the deployment descriptor of the given application.
In this way, client authentication is enabled only for a specific resource controlled by the security constraint, and the check is performed only when the application requires client authentication.</p>
</li>
<li>
<p>A less commonly used method is to set the <code>clientAuth</code> property in the <code>certificate</code> realm to <code>true</code> if you want the SSL stack to require a valid certificate chain from the client before accepting a connection.
A <code>false</code> value (which is the default) will not require a certificate chain unless the client requests a resource protected by a security constraint that uses <code>CLIENT-CERT</code> authentication.
When you enable client authentication by setting the <code>clientAuth</code> property to <code>true</code>, client authentication will be required for all the requests going through the specified SSL port.
If you turn <code>clientAuth</code> on, it is on all of the time, which can severely degrade performance.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When client authentication is enabled in both of these ways, client authentication will be performed twice.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_client_certificate_for_mutual_authentication"><a class="anchor" href="#_creating_a_client_certificate_for_mutual_authentication"></a>Creating a Client Certificate for Mutual Authentication</h4>
<div class="paragraph">
<p>If you have a certificate signed by a trusted Certificate Authority (CA) such as Verisign, and the GlassFish Server <code>cacerts.jks</code> file already contains a certificate verified by that CA, you do not need to complete this step.
You need to install your certificate in the GlassFish Server certificate file only when your certificate is self-signed.</p>
</div>
<div class="paragraph">
<p>From the directory where you want to create the client certificate, run <code>keytool</code> as outlined here.
When you press Enter, <code>keytool</code> prompts you to enter the server name, organizational unit, organization, locality, state, and country code.</p>
</div>
<div class="paragraph">
<p>You must enter the server name in response to <code>keytool</code>'s first prompt, in which it asks for first and last names.
For testing purposes, this can be <code>localhost</code>.
If this example is to verify mutual authentication and you receive a runtime error stating that the HTTPS host name is wrong, re-create the client certificate, being sure to use the same host name you will use when running the example.
For example, if your machine name is <code>duke</code>, then enter <code>duke</code> as the certificate CN or when prompted for first and last names.
When accessing the application, enter a URL that points to the same location (for example, <code>https://duke:8181/mutualauth/hello</code>).
This is necessary because during SSL handshake, the server verifies the client certificate by comparing the certificate name to the host name from which it originates.</p>
</div>
<div class="paragraph">
<p>To create a keystore named <code>client_keystore.jks</code> that contains a client certificate named <code>client.cer</code>, follow these steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a backup copy of the server truststore file.
To do this,</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change to the directory containing the server&#8217;s keystore and truststore files, <code><em>domain-dir</em>\config</code>.</p>
</li>
<li>
<p>Copy <code>cacerts.jks</code> to <code>cacerts.backup.jks</code>.</p>
</li>
<li>
<p>Copy <code>keystore.jks</code> to <code>keystore.backup.jks</code>.</p>
<div class="paragraph">
<p>Do not put client certificates in the <code>cacerts.jks</code> file.
Any certificate you add to the <code>cacerts</code> file effectively can be a trusted root for any and all certificate chains.
After you have completed development, delete the development version of the <code>cacerts</code> file and replace it with the original copy.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Generate the client certificate.
Enter the following command from the directory where you want to generate the client certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java-home/bin/keytool -genkey -alias client-alias -keyalg RSA -keypass changeit -storepass changeit -keystore client_keystore.jks</code></pre>
</div>
</div>
</li>
<li>
<p>Export the generated client certificate into the file <code>client.cer</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java-home/bin/keytool -export -alias client-alias -storepass changeit -file client.cer -keystore client_keystore.jks</code></pre>
</div>
</div>
</li>
<li>
<p>Add the certificate to the truststore file <code><em>domain-dir</em>/config/cacerts.jks</code>.
Run <code>keytool</code> from the directory where you created the keystore and client certificate.
Use the following parameters:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">java-home/bin/keytool -import -v -trustcacerts -alias client-alias
-file client.cer -keystore domain-dir/config/cacerts.jks
-keypass changeit -storepass changeit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>keytool</code> utility returns a message like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">Owner: CN=localhost, OU=My Company, O=Software, L=Santa Clara, ST=CA, C=US
Issuer: CN=localhost, OU=My Company, O=Software, L=Santa Clara, ST=CA, C=US
Serial number: 3e39e66a
Valid from: Tue Nov 27 12:22:47 EST 2012 until: Mon Feb 25 12:22:47 EST 2013
Certificate fingerprints:
    MD5: 5A:B0:4C:88:4E:F8:EF:E9:E5:8B:53:BD:D0:AA:8E:5A
    SHA1:90:00:36:5B:E0:A7:A2:BD:67:DB:EA:37:B9:61:3E:26:B3:89:46:32
    Signature algorithm name: SHA1withRSA
    Version: 3
Trust this certificate? [no]: yes
Certificate was added to keystore
[Storing cacerts.jks]</code></pre>
</div>
</div>
</li>
<li>
<p>Restart GlassFish Server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
